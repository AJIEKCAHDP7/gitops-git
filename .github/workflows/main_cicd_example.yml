name: CI-CD Pipeline                     # Название workflow (видно в GitHub UI)

on:                                       # Когда запускать workflow
  push:
    branches:
      - main                              # Запуск при пуше в main
  pull_request:
    branches:
      - main                              # Запуск при создании PR в main

env:                                      # Глобальные переменные окружения
  IMAGE_NAME: my-app                      # Имя Docker образа
  REGISTRY: ghcr.io                       # Реестр (можно docker.io)

jobs:                                     # Набор job'ов (этапов)
  build:                                  # Job 1 — сборка
    runs-on: ubuntu-latest                # GitHub runner (виртуальная машина)

    steps:                                # Шаги внутри job
      - name: Checkout repository
        uses: actions/checkout@v4         # Клонирует репозиторий

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # Включает расширенную сборку Docker

      - name: Login to registry
        uses: docker/login-action@v3      # Логин в registry
        with:
          registry: ${{ env.REGISTRY }}   # Берём registry из env
          username: ${{ github.actor }}   # Имя пользователя GitHub
          password: ${{ secrets.GITHUB_TOKEN }} # Токен GitHub

      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/${{ github.repository }}:latest .
          # Собираем образ из Dockerfile

      - name: Push Docker image
        run: |
          docker push $REGISTRY/${{ github.repository }}:latest
          # Отправляем образ в registry

  deploy:                                 # Job 2 — деплой
    needs: build                          # Запускать только если build успешен
    runs-on: ubuntu-latest                # Runner

    if: github.ref == 'refs/heads/main'   # Деплой только из main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0                 # Версия kubectl

      - name: Set kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV
          # Раскодируем kubeconfig из secret

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/           # Применяем манифесты
          kubectl rollout status deploy/my-app
          # Проверяем, что деплой успешен
